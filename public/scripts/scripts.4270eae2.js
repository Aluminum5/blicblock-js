(function(){"use strict";angular.module("blicblockApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","LocalStorageModule","angularMoment"]).config(["$routeProvider","localStorageServiceProvider",function(a,b){return b.setPrefix("blicblockJS"),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/test/:color_count",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/scores",{templateUrl:"views/scores.html",controller:"ScoresCtrl"}).otherwise({redirectTo:"/"})}])}).call(this),function(){var a;a=function(){function a(a){this.color=a.color,this.x=a.x,this.y=a.y,this.locked=!1,this.active=!0,this.sliding=!1,this.plumetting=!1,this.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b,c;return b=16*Math.random()|0,c="x"===a?b:3&b|8,c.toString(16)})}return a}(),("undefined"!=typeof exports&&null!==exports?exports:this).Block=a}.call(this),function(){var a;a=function(){function a(a){this.blocks=[],this.index=a}return a.prototype.append=function(a){return this.blocks.push(a)},a}(),("undefined"!=typeof exports&&null!==exports?exports:this).BlockRow=a}.call(this),function(){"use strict";angular.module("blicblockApp").directive("ngLeft",function(){return function(a,b,c){var d;return d=void 0,b.bind("keydown keypress",function(b){return $(b.target).is("input")||!b.which||d&&d.which===b.which?void 0:(d=b,37===b.which||"a"===String.fromCharCode(b.which)?(a.$apply(function(){return a.$eval(c.ngLeft)}),b.preventDefault()):void 0)}),b.bind("keyup",function(){return d=void 0})}})}.call(this),function(){"use strict";angular.module("blicblockApp").directive("ngRight",function(){return function(a,b,c){var d;return d=void 0,b.bind("keydown keypress",function(b){return $(b.target).is("input")||!b.which||d&&d.which===b.which?void 0:(d=b,39===b.which||"d"===String.fromCharCode(b.which)?(a.$apply(function(){return a.$eval(c.ngRight)}),b.preventDefault()):void 0)}),b.bind("keyup",function(){return d=void 0})}})}.call(this),function(){"use strict";angular.module("blicblockApp").directive("ngDown",function(){return function(a,b,c){return b.bind("keydown keypress",function(b){return!$(b.target).is("input")&&b.which&&(40===b.which||"s"===String.fromCharCode(b.which))?(a.$apply(function(){return a.$eval(c.ngDown)}),b.preventDefault()):void 0})}})}.call(this),function(){"use strict";angular.module("blicblockApp").directive("ngSpace",function(){return function(a,b,c){return b.bind("keydown keypress",function(b){return b.which&&32===b.which?(a.$apply(function(){return a.$eval(c.ngSpace)}),b.preventDefault()):void 0})}})}.call(this),function(){"use strict";angular.module("blicblockApp").service("Config",function(){var a;return new(a=function(){function a(){this.storage_keys={high_score:"high_score"}}return a}())})}.call(this),function(){"use strict";angular.module("blicblockApp").service("Tetromino",["$rootScope","$interval",function(a,b){var c;return new(c=function(){function a(){this.blocks=[],this.info={cols:5,rows:7,score_value:1e3,checking:!1,in_progress:!0,plumetting_block:!1,sliding_block:!1,game_over:!1,current_score:0,tick_length_decrement_pct:.09,tick_length:1200,level:1,test_mode:!1,submitted_score:!1},this.info.middle_col_idx=(this.info.cols-1)/2}return a.prototype.get_active_block=function(){return this.blocks.filter(function(a){return a.active})[0]},a.prototype.get_middle_column_blocks=function(){return this.blocks.filter(function(a){return function(b){return b.y===a.info.middle_col_idx}}(this))},a.prototype.check_for_tetrominos=function(){var a,b,c,d;if(this.info.in_progress&&!this.info.checking){for(this.info.checking=!0,d=this.blocks,b=0,c=d.length;c>b;b++)a=d[b],a&&a.locked&&!a.active&&(this.check_for_straight_tetromino(a),this.check_for_square_tetromino(a),this.check_for_l_tetromino(a),this.check_for_z_tetromino(a),this.check_for_t_tetromino(a));return this.info.checking=!1}},a.prototype.get_closest_block_to_left=function(a,b){var c;return c=this.blocks.filter(function(c){return c.x===a&&c.y<b}),c.sort(function(a,b){return a.y<b.y?-1:a.y>b.y?1:0}),c[c.length-1]},a.prototype.get_closest_block_to_right=function(a,b){var c;return c=this.blocks.filter(function(c){return c.x===a&&c.y>b}),c.sort(function(a,b){return a.y<b.y?-1:a.y>b.y?1:0}),c[0]},a.prototype.get_closest_block_below=function(a,b){var c;return c=this.blocks.filter(function(c){return c.x>a&&c.y===b}),c.sort(function(a,b){return a.x<b.x?-1:a.x>b.x?1:0}),c[0]},a.prototype.is_block_directly_below=function(a,b){return this.blocks.filter(function(c){return c.x===a+1&&c.y===b})[0]},a.prototype.plummet_block=function(a,c,d){var e,f;return f=void 0,e=function(e){return function(){return a.plumetting=!0,e.info.plumetting_block=!0,a.x<c?a.x++:a.x===c&&(b.cancel(f),f=void 0,a.locked=!0,a.active=!1,e.info.plumetting_block=!1,a.plumetting=!1,e.on_block_land(a),d)?d():void 0}}(this),e(),f=b(e,25)},a.prototype.blocks_on_top=function(a){var b,c,d,e,f;return e=function(){var c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.x);return e}(),f=function(){var c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.y);return e}(),c=Math.max.apply(Math,e),d=this.blocks.filter(function(a){return a.x<c&&f.indexOf(a.y)>-1}),d.sort(function(a,b){return a.x<b.x?1:a.x>b.x?-1:0}),d},a.prototype.drop_blocks=function(){var a,b,c,d,e,f;if(this.info.in_progress){for(e=this.blocks,f=[],c=0,d=e.length;d>c;c++)b=e[c],b&&(b.sliding||(a=b.active||!b.locked,b.x===this.info.rows-1&&a&&(b.locked=!0,b.active=!1,this.on_block_land(b)),this.is_block_directly_below(b.x,b.y)&&a&&(b.locked=!0,b.active=!1,this.on_block_land(b)),b.locked||f.push(b.x++)));return f}},a.prototype.on_block_land=function(){return this.check_for_tetrominos()},a.prototype.increment_level_if_necessary=function(){return this.info.current_score%4e3===0?this.info.level++:void 0},a.prototype.plummet_blocks=function(a,b){var c,d,e;return"undefined"==typeof b&&(b=0),c=a[b],d=this.get_closest_block_below(c.x,c.y),e=d?d.x-1:this.info.rows-1,this.plummet_block(c,e,function(c){return function(){return b<a.length-1?c.plummet_blocks(a,b+1):void 0}}(this))},a.prototype.remove_blocks=function(a){var b,c,d;if(this.info.in_progress){for(b=a.map(function(a){return a.id}),c=this.blocks.length-1;c>=0;)b.indexOf(this.blocks[c].id)>-1&&this.blocks.splice(c,1),c--;return this.info.current_score+=this.info.score_value,this.increment_level_if_necessary(),d=this.blocks_on_top(a),d=d.filter(function(a){return!a.active}),d.length>0&&this.plummet_blocks(d),this.check_for_tetrominos()}},a.prototype.lookup=function(a,b,c){return a>=this.info.rows||b>=this.info.cols?void 0:this.blocks.filter(function(d){return d.x===a&&d.y===b&&d.color===c})[0]},a.prototype.check_for_straight_tetromino=function(a){return this.check_for_straight_hor_tetromino(a),this.check_for_straight_ver_tetromino(a)},a.prototype.check_for_straight_hor_tetromino=function(a){var b,c,d,e,f,g;return g=a.y,f=a.x,e=a.color,b=this.lookup(f,g+1,e),b&&(c=this.lookup(f,g+2,e),c&&(d=this.lookup(f,g+3,e)))?this.remove_blocks([a,b,c,d]):void 0},a.prototype.check_for_straight_ver_tetromino=function(a){var b,c,d,e,f,g;return f=a.x,g=a.y,e=a.color,b=this.lookup(f+1,g,e),b&&(c=this.lookup(f+2,g,e),c&&(d=this.lookup(f+3,g,e)))?this.remove_blocks([a,b,c,d]):void 0},a.prototype.check_for_square_tetromino=function(a){var b,c,d,e,f,g;return f=a.x,g=a.y,e=a.color,b=this.lookup(f,g+1,e),b&&(c=this.lookup(f+1,g,e),c&&(d=this.lookup(f+1,g+1,e)))?this.remove_blocks([a,b,c,d]):void 0},a.prototype.check_for_l_tetromino=function(a){return this.check_for_left_l_tetromino(a),this.check_for_right_l_tetromino(a)},a.prototype.check_for_left_l_tetromino=function(a){var b,c,d,e,f,g;if(f=a.x,g=a.y,e=a.color,b=this.lookup(f+1,g,e)){if(c=this.lookup(f+2,g,e)){if(d=this.lookup(f+2,g-1,e))return this.remove_blocks([a,b,c,d]);if(d=this.lookup(f,g+1,e),!d)return;return this.remove_blocks([a,b,c,d])}if(c=this.lookup(f+1,g+1,e)){if(d=this.lookup(f+1,g+2,e),!d)return;return this.remove_blocks([a,b,c,d])}if((c=this.lookup(f,g-1,e))&&(d=this.lookup(f,g-2,e)))return this.remove_blocks([a,b,c,d])}},a.prototype.check_for_right_l_tetromino=function(a){var b,c,d,e,f,g;if(f=a.x,g=a.y,e=a.color,b=this.lookup(f+1,g,e)){if(c=this.lookup(f+2,g,e)){if(d=this.lookup(f+2,g+1,e))return this.remove_blocks([a,b,c,d]);if(d=this.lookup(f,g-1,e),!d)return;return this.remove_blocks([a,b,c,d])}if(c=this.lookup(f+1,g-1,e)){if(d=this.lookup(f+1,g-2,e),!d)return;return this.remove_blocks([a,b,c,d])}if((c=this.lookup(f,g+1,e))&&(d=this.lookup(f,g+2,e)))return this.remove_blocks([a,b,c,d])}},a.prototype.check_for_z_tetromino=function(a){var b,c,d,e,f,g;if(f=a.x,g=a.y,e=a.color,b=this.lookup(f+1,g,e)){if(c=this.lookup(f,g-1,e)){if(d=this.lookup(f+1,g+1,e),!d)return;return this.remove_blocks([a,b,c,d])}if(c=this.lookup(f,g+1,e)){if(d=this.lookup(f+1,g-1,e),!d)return;return this.remove_blocks([a,b,c,d])}if(c=this.lookup(f+1,g+1,e)){if(d=this.lookup(f+2,g+1,e),!d)return;return this.remove_blocks([a,b,c,d])}if((c=this.lookup(f+1,g-1,e))&&(d=this.lookup(f+2,g-1,e)))return this.remove_blocks([a,b,c,d])}},a.prototype.check_for_t_tetromino=function(a){var b,c,d,e,f,g;if(f=a.x,g=a.y,e=a.color,b=this.lookup(f+1,g,e)){if(c=this.lookup(f+2,g,e)){if(d=this.lookup(f+1,g+1,e))return this.remove_blocks([a,b,c,d]);if(d=this.lookup(f+1,g-1,e),!d)return;return this.remove_blocks([a,b,c,d])}if(c=this.lookup(f+1,g-1,e)){if(d=this.lookup(f+1,g+1,e),!d)return;return this.remove_blocks([a,b,c,d])}if((c=this.lookup(f,g-1,e))&&(d=this.lookup(f,g+1,e)))return this.remove_blocks([a,b,c,d])}},a}())}])}.call(this),function(){"use strict";angular.module("blicblockApp").factory("Score",["$resource",function(a){return a("/api/scores/:id.json",null,{update:{method:"PUT"}})}])}.call(this),function(){"use strict";angular.module("blicblockApp").service("Notification",["$timeout",function(a){var b;return new(b=function(){function b(){this.notices=[],this.errors=[]}return b.prototype.wipe_notices=function(){var a,b,c,d,e;for(d=this.notices,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.remove("notice",a.id));return e},b.prototype.wipe_errors=function(){var a,b,c,d,e;for(d=this.errors,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.remove("error",a.id));return e},b.prototype.wipe_notifications=function(){return this.wipe_notices(),this.wipe_errors()},b.prototype.remove=function(a,b){var c,d,e,f,g,h,i;if("error"===a){f=this.errors,h=[];for(d in f)c=f[d],c.id===b&&h.push(this.errors.splice(d,1));return h}g=this.notices,i=[];for(d in g)e=g[d],e.id===b&&i.push(this.notices.splice(d,1));return i},b.prototype.error=function(b){var c;if(b)return console.error(b),c=this.errors.length+1,this.errors.push({message:b,id:c}),a(function(a){return function(){return a.remove("error",c)}}(this),3e3)},b.prototype.notice=function(b){var c;if(b)return c=this.notices.length+1,this.notices.push({message:b,id:c}),a(function(a){return function(){return a.remove("notice",c)}}(this),3e3)},b}())}])}.call(this),function(){"use strict";angular.module("blicblockApp").controller("NotificationsCtrl",["$scope","$cookieStore","Notification",function(a,b,c){var d;return a.notices=c.notices,a.errors=c.errors,a.remove=function(a,b){return c.remove(a,b)},d=b.get("error"),d?(c.error(d),b.remove("error")):void 0}])}.call(this),function(){"use strict";angular.module("blicblockApp").controller("MainCtrl",["$scope","$window","$timeout","$interval","$routeParams","localStorageService","Config","Tetromino","Score","Notification",function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;return a.blocks=h.blocks,a.upcoming=[],a.game_info=h.info,a.score_record=new i,a.new_high_score={},q=void 0,a.new_game=function(){return a.score_record=new i,b.location.reload()},k=["magenta","orange","yellow","green","blue","white"],e.color_count?(m=parseInt(e.color_count,10),m>k.length&&(m=k.length-1),1>m&&(m=1),n=k.slice(0,m),a.game_info.test_mode=!0):(n=k,a.game_info.test_mode&&a.new_game(),a.game_info.test_mode=!1),u=function(){var b;return a.game_info.test_mode?{value:-1e6,date:new Date(1969,0,1)}:(b=f.get(g.storage_keys.high_score),b?b:{})},a.existing_high_score=u(),t=function(){return n[Math.floor(Math.random()*n.length)]},l=function(){return angular.isDefined(q)?(d.cancel(q),q=void 0):void 0},w=function(){var b,c;if(!a.game_info.test_mode)return c=f.get(g.storage_keys.high_score),b=a.game_info.current_score,a.score_record.value=b,c&&c.value<b||!c?(c={value:b,date:new Date},f.set(g.storage_keys.high_score,c),a.new_high_score.value=c.value):void 0},a.record_high_score=function(){var b,c;if(!a.game_info.test_mode)return c=function(){return j.notice("Your score has been recorded!"),a.game_info.submitted_score=!0},b=function(a){return j.error("Failed to record your score: "+a.data.error)},a.score_record.$save(c,b)},s=function(){return a.game_info.in_progress=!1,a.game_info.game_over=!0,l(),w()},v=function(){return a.upcoming[1]=new Block({color:t()})},o=function(){var b,c,d,e,f;if(!a.game_info.checking){if(c=h.get_middle_column_blocks(),c.length<a.game_info.rows){if(e=0,f=a.game_info.middle_col_idx,d=a.blocks.filter(function(a){return a.x===e&&a.y===f})[0])return;return b=a.upcoming[0],b.x=e,b.y=f,a.upcoming[0]=a.upcoming[1],v(),a.blocks.push(b)}return s()}},p=function(){var a;return(a=h.get_active_block())?void 0:o()},r=function(){return!a.game_info.in_progress||a.game_info.plumetting_block||a.game_info.sliding_block?void 0:(h.drop_blocks(),p())},x=function(){return angular.isDefined(q)?void 0:q=d(r,a.game_info.tick_length)},a.upcoming.push(new Block({color:t()})),a.upcoming.push(new Block({color:t()})),a.$on("pause",function(){return a.game_info.plumetting_block?void 0:(a.game_info.in_progress=!1,l())}),a.$on("resume",function(){return a.game_info.in_progress=!0,x()}),a.$on("toggle_pause",function(){return a.game_info.in_progress?a.$emit("pause"):a.game_info.game_over?void 0:a.$emit("resume")}),y=function(b){return b.sliding=!1,a.game_info.sliding_block=!1},a.$on("move_left",function(){var b,d;if(a.game_info.in_progress&&(b=h.get_active_block(),b&&!b.plumetting&&!b.sliding&&0!==b.y))return b.sliding=!0,a.game_info.sliding_block=!0,d=h.get_closest_block_to_left(b.x,b.y),d?b.y=d.y+1:b.y--,c(function(){return y(b)},150)}),a.$on("move_right",function(){var b,d;if(a.game_info.in_progress&&(b=h.get_active_block(),b&&!b.plumetting&&!b.sliding&&b.y!==a.game_info.cols-1))return b.sliding=!0,a.game_info.sliding_block=!0,d=h.get_closest_block_to_right(b.x,b.y),d?b.y=d.y-1:b.y++,c(function(){return y(b)},150)}),a.$on("move_down",function(){var b,c,d;if(a.game_info.in_progress&&(b=h.get_active_block(),b&&!b.plumetting&&!b.sliding&&b.x!==a.game_info.rows-1))return c=h.get_closest_block_below(b.x,b.y),d=c?c.x-1:a.game_info.rows-1,h.plummet_block(b,d,function(){return l(),p(),x()})}),a.$watch("game_info.level",function(){return a.game_info.level>1&&(a.game_info.tick_length-=a.game_info.tick_length*a.game_info.tick_length_decrement_pct,l()),x()}),a.$on("$locationChangeStart",function(){return a.$emit("pause")}),a.capitalize_initials=function(){return a.score_record.initials?a.score_record.initials=a.score_record.initials.toUpperCase():void 0}}])}.call(this),function(){"use strict";angular.module("blicblockApp").controller("HowToPlayModalCtrl",["$rootScope","$scope","$modal",function(a,b,c){return b.open=function(){var b,d,e;return a.$broadcast("pause"),b=c.open({templateUrl:"how-to-play-modal-content.html",controller:"HowToPlayModalInstanceCtrl"}),e=function(){return a.$broadcast("resume")},d=e,b.result.then(e,d)}}])}.call(this),function(){"use strict";angular.module("blicblockApp").controller("HowToPlayModalInstanceCtrl",["$scope","$modalInstance",function(a,b){return a.ok=function(){return b.close()},a.cancel=function(){return b.dismiss("cancel")}}])}.call(this),function(){"use strict";angular.module("blicblockApp").controller("AboutCtrl",["$scope",function(){}])}.call(this),function(){"use strict";angular.module("blicblockApp").controller("ScoresCtrl",["$scope","Score",function(a,b){return a.scores=b.query()}])}.call(this);